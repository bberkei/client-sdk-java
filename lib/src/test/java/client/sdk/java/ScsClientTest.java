/*
 * This Java source file was generated by the Gradle 'init' task.
 */
package client.sdk.java;

import grpc.cache_client.Result;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.nio.charset.StandardCharsets;
import java.util.concurrent.CompletionStage;
import java.util.concurrent.ExecutionException;

class ScsClientTest {
    ScsClient c;

    @BeforeEach
    void setUp() {
        c = new ScsClient("FIXME");
    }

    @Test
    void testBlockingClientHappyPath() {
        try {
            //Set Key sync
            ClientSetResponse setRsp = c.set(
                    "foo",
                    new ByteArrayInputStream("bar".getBytes(StandardCharsets.UTF_8)),
                    100
            );
            Assertions.assertEquals(Result.Ok, setRsp.getResult());

            // Get Key that was just set
            ClientGetResponse<InputStream> rsp = c.get("foo");

            Assertions.assertEquals(Result.Hit, rsp.getResult());
            Assertions.assertEquals("bar", new String(rsp.getBody().readAllBytes()));

        } catch (IOException e) {
            Assertions.fail(e);
        }
    }

    @Test
    void testAsyncClientHappyPath() {
        try {

            // Set Key Async
            CompletionStage<ClientSetResponse> setRsp = c.setAsync(
                    "foo",
                    new ByteArrayInputStream("bar".getBytes(StandardCharsets.UTF_8)),
                    100
            );
            Assertions.assertEquals(Result.Ok, setRsp.toCompletableFuture().get().getResult());

            // Get Key Async
            CompletionStage<ClientGetResponse<InputStream>> futureGetRsp = c.getAsync("foo");
            ClientGetResponse<InputStream> rsp = futureGetRsp.toCompletableFuture().get();

            Assertions.assertEquals(Result.Hit, rsp.getResult());
            Assertions.assertEquals("bar", new String(rsp.getBody().readAllBytes()));

        } catch (IOException | InterruptedException | ExecutionException e) {
            Assertions.fail(e);
        }
    }

}
